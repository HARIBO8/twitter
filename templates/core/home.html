{% extends 'base.html' %}

{% block title %}ãƒ›ãƒ¼ãƒ {% endblock %}

{% block content %}

<!-- ğŸ” æŠ•ç¨¿ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
<div style="display: flex; gap: 20px; margin-bottom: 20px;">
  <a href="{% url 'home' %}?filter=all" class="{% if filter_type == 'all' %}active-tab{% endif %}" style="padding: 10px; text-decoration: none;">
    ğŸ“¢ For You
  </a>
  <a href="{% url 'home' %}?filter=follow" class="{% if filter_type == 'follow' %}active-tab{% endif %}" style="padding: 10px; text-decoration: none;">
    ğŸ‘¥ Following
  </a>
</div>

<style>
.active-tab {
  border-bottom: 3px solid dodgerblue;
  font-weight: bold;
}
</style>


<!-- âœ… æŠ•ç¨¿è¡¨ç¤º -->
{% if tweets %}
  {% for tweet in tweets %}
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
      
      {% if tweet.original %}
        <!-- ğŸ” ãƒªãƒã‚¹ãƒˆã®å ´åˆ -->
        <p><strong>{{ tweet.user.username }}</strong> ãŒãƒªãƒã‚¹ãƒˆã—ã¾ã—ãŸï¼š</p>
        <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ccc;">
          <p><strong><a href="{% url 'user_profile' tweet.original.user.id %}">{{ tweet.original.user.username }}</a></strong>: {{ tweet.original.content }}</p>
          <small>{{ tweet.original.created_at }}</small>
          <div>
            <button class="reply-btn" data-id="{{ tweet.original.id }}">ğŸ’¬ {{ tweet.original.replies.count }}ä»¶</button>
            <button class="retweet-btn" data-id="{{ tweet.original.id }}">ğŸ” {{ tweet.original.retweets.count }}ä»¶</button>
            <button class="like-btn" data-id="{{ tweet.original.id }}">â¤ï¸ {{ tweet.original.likes.count }}</button>
          </div>
        </div>
      {% else %}
        <!-- ğŸ“ é€šå¸¸æŠ•ç¨¿ -->
        <p><strong><a href="{% url 'user_profile' tweet.user.id %}">{{ tweet.user.username }}</a></strong>: {{ tweet.content }}</p>
        <small>{{ tweet.created_at }}</small>
        <div>
          <button class="reply-btn" data-id="{{ tweet.id }}">ğŸ’¬ {{ tweet.replies.count }}ä»¶</button>
          <button class="retweet-btn" data-id="{{ tweet.id }}">ğŸ” {{ tweet.retweets.count }}ä»¶</button>
          <button class="like-btn" data-id="{{ tweet.id }}">â¤ï¸ {{ tweet.likes.count }}</button>
        </div>
      {% endif %}

      <!-- ğŸ’¬ ãƒªãƒ—ãƒ©ã‚¤è¡¨ç¤ºï¼ˆãƒªãƒã‚¹ãƒˆå…ƒ or é€šå¸¸ï¼‰ -->
      {% if tweet.original %}
        {% if tweet.original.replies.all %}
          <div style="margin-left: 30px; padding: 5px; background: #f5f5f5;">
            <strong>ğŸ’¬ ãƒªãƒ—ãƒ©ã‚¤</strong><br>
            {% for reply in tweet.original.replies.all %}
              <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        {% if tweet.replies.all %}
          <div style="margin-left: 30px; padding: 5px; background: #f5f5f5;">
            <strong>ğŸ’¬ ãƒªãƒ—ãƒ©ã‚¤</strong><br>
            {% for reply in tweet.replies.all %}
              <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}

    </div>
  {% endfor %}
{% else %}
  <p>æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {

    // â¤ï¸ Likeãƒœã‚¿ãƒ³
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tweetId = btn.dataset.id;
        fetch(`/like/${tweetId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Accept': 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          btn.innerHTML = `â¤ï¸ ${data.count}ä»¶`;
        });
      });
    });

    // ğŸ” Retweetãƒœã‚¿ãƒ³
    document.querySelectorAll('.retweet-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tweetId = btn.dataset.id;
        fetch(`/retweet_toggle/${tweetId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Accept': 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          btn.innerHTML = `ğŸ” ${data.count}ä»¶`;
        });
      });
    });

    // ğŸ’¬ ãƒªãƒ—ãƒ©ã‚¤ãƒœã‚¿ãƒ³ï¼ˆéonclickå½¢å¼ï¼‰
    document.querySelectorAll('.reply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tweetId = btn.dataset.id;
        window.location.href = `/reply/${tweetId}/`;
      });
    });

  });
</script>


{% endblock %}