{% extends 'base.html' %}

{% block title %}ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«{% endblock %}

{% block content %}

  <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>

  {% if profile.avatar %}
    <img src="{{ profile.avatar.url }}" width="100" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ">
  {% endif %}

  <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼š</strong> {{ request.user.username }}</p>
  <p><strong>è‡ªå·±ç´¹ä»‹ï¼š</strong> {{ profile.bio }}</p>

  <hr>

<p>
  <button onclick="loadFollowList('followers')">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§</button>
  <button onclick="loadFollowList('following')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§</button>
</p>

<div id="follow-list-popup" style="display:none; border:1px solid #ccc; padding:10px;"></div>

<script>
function loadFollowList(type) {
  const userId = "{{ request.user.id }}";  // â† æ–‡å­—åˆ—ã¨ã—ã¦å—ã‘å–ã‚‹
  fetch(`/${type}/${userId}/`)
    .then(response => response.json())
    .then(data => {
      const div = document.getElementById('follow-list-popup');
      div.innerHTML = '<h3>' + (type === 'followers' ? 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼' : 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­') + '</h3>';
      data.forEach(user => {
        div.innerHTML += '<p>' + user.username + '</p>';
      });
      div.style.display = 'block';
    });
}
</script>



  <hr>

  <h3>ğŸ“ ã‚ãªãŸã®æŠ•ç¨¿</h3>

  {% for tweet in tweets %}
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
      {% if tweet.original %}
        <p><strong>{{ tweet.user.username }}</strong> ãŒãƒªãƒã‚¹ãƒˆã—ã¾ã—ãŸï¼š</p>
        <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ccc;">
          <p><strong>{{ tweet.original.user.username }}</strong>: {{ tweet.original.content }}</p>
          <small>{{ tweet.original.created_at }}</small>
          <div>
            <button class="reply-btn" data-id="{{ tweet.original.id }}">ğŸ’¬ {{ tweet.original.replies.count }}ä»¶</button>
            <button class="retweet-btn" data-id="{{ tweet.original.id }}">ğŸ” {{ tweet.original.retweets.count }}ä»¶</button>
            <button class="like-btn" data-id="{{ tweet.original.id }}">â¤ï¸ {{ tweet.original.likes.count }}ä»¶</button>
          </div>
        </div>
      {% else %}
        <p><strong>{{ tweet.user.username }}</strong>: {{ tweet.content }}</p>
        <small>{{ tweet.created_at }}</small>
        <div>
          <button class="reply-btn" data-id="{{ tweet.id }}">ğŸ’¬ {{ tweet.replies.count }}ä»¶</button>
          <button class="retweet-btn" data-id="{{ tweet.id }}">ğŸ” {{ tweet.retweets.count }}ä»¶</button>
          <button class="like-btn" data-id="{{ tweet.id }}">â¤ï¸ {{ tweet.likes.count }}ä»¶</button>
        </div>
        {% if not tweet.original %}
          <div style="margin-top: 5px;">
            <a href="{% url 'edit_tweet' tweet.id %}">âœï¸ ç·¨é›†</a> |
            <a href="{% url 'delete_tweet' tweet.id %}" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">ğŸ—‘ï¸ å‰Šé™¤</a>
          </div>
        {% endif %}
      {% endif %}
    </div>
  {% empty %}
    <p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endfor %}

<script>
  document.addEventListener('DOMContentLoaded', () => {

    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        fetch(`/like/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Accept': 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          btn.innerHTML = `â¤ï¸ ${data.count}ä»¶`;
        });
      });
    });

    document.querySelectorAll('.retweet-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        fetch(`/retweet_toggle/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Accept': 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          btn.innerHTML = `ğŸ” ${data.count}ä»¶`;
        });
      });
    });

    document.querySelectorAll('.reply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        window.location.href = `/reply/${id}/`;
      });
    });

  });
</script>

{% endblock %}
