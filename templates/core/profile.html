{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }}のプロフィール{% endblock %}

{% block content %}
  <!-- アイコンと名前を横並びに -->
  <div style="display: flex; align-items: center; margin-bottom: 15px;">
    <div style="margin-right: 15px;">
      {% if profile_user.profile.avatar %}
        <img src="{{ profile_user.profile.avatar.url }}" class="img-circle" style="width:100px; height:100px;" alt="アイコン">
      {% else %}
        <img src="{% static 'default_icon.png' %}" class="img-circle" style="width:100px; height:100px;" alt="デフォルトアイコン">
      {% endif %}
    </div>
    <div>
      <h2 style="margin: 0;">{{ profile_user.username }} のプロフィール</h2>
    </div>
  </div>


  <p><strong>自己紹介：</strong> {{ profile.bio }}</p>

  <hr>

  {% if request.user == profile_user %}
    <!-- 自分のプロフィール：フォロー/フォロワー一覧 -->
    <p>
      <button onclick="loadFollowList('followers')">フォロワー一覧</button>
      <button onclick="loadFollowList('following')">フォロー中一覧</button>
    </p>
    <p>
      <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-default">
        ⚙️ プロフィールを編集
      </a>
    </p>
    <div id="follow-list-popup" style="display:none; border:1px solid #ccc; padding:10px;"></div>
  {% else %}
    <!-- 他人のプロフィール：フォローボタン -->
    <button id="follow-btn" data-user-id="{{ profile_user.id }}">
      フォロー
    </button>
  {% endif %}

  <hr>

  <h3>📝 {{ profile_user.username }} の投稿</h3>

  {% for tweet in tweets %}
    {% include 'core/tweet_card.html' with tweet=tweet show_controls=is_owner %}
  {% endfor %}

  {% if request.user == profile_user %}
    <script>
      function loadFollowList(type) {
        const userId = "{{ profile_user.id }}";
        fetch(`/${type}/${userId}/`)
          .then(response => response.json())
          .then(data => {
            const div = document.getElementById('follow-list-popup');
            div.innerHTML = '<h3>' + (type === 'followers' ? 'フォロワー' : 'フォロー中') + '</h3>';
            data.forEach(user => {
              div.innerHTML += '<p>' + user.username + '</p>';
            });
            div.style.display = 'block';
          });
      }
    </script>
  {% endif %}

  {% if request.user != profile_user %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('follow-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            fetch(`/follow-toggle/${userId}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Accept': 'application/json',
              }
            })
            .then(response => response.json())
            .then(data => {
              btn.textContent = data.status === 'followed' ? 'フォロー解除' : 'フォロー';
            });
          });
        }
      });
    </script>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          fetch(`/like/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          })
          .then(res => res.json())
          .then(data => {
            btn.innerHTML = `❤️ ${data.count}件`;
          });
        });
      });

      document.querySelectorAll('.retweet-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          fetch(`/retweet_toggle/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          })
          .then(res => res.json())
          .then(data => {
            btn.innerHTML = `🔁 ${data.count}件`;
          });
        });
      });

      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          window.location.href = `/reply/${id}/`;
        });
      });
    });
  </script>

{% endblock %}
