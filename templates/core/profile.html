{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }}ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«{% endblock %}

{% block content %}
  <!-- ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰ã‚’æ¨ªä¸¦ã³ã« -->
  <div style="display: flex; align-items: center; margin-bottom: 15px;">
    <div style="margin-right: 15px;">
      {% if profile_user.profile.avatar %}
        <img src="{{ profile_user.profile.avatar.url }}" class="img-circle" style="width:100px; height:100px;" alt="ã‚¢ã‚¤ã‚³ãƒ³">
      {% else %}
        <img src="{% static 'default_icon.png' %}" class="img-circle" style="width:100px; height:100px;" alt="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³">
      {% endif %}
    </div>
    <div>
      <h2 style="margin: 0;">{{ profile_user.username }} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
    </div>
  </div>


  <p><strong>è‡ªå·±ç´¹ä»‹ï¼š</strong> {{ profile.bio }}</p>

  <hr>

  {% if request.user == profile_user %}
    <!-- è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§ -->
    <p>
      <button onclick="loadFollowList('followers')">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ä¸€è¦§</button>
      <button onclick="loadFollowList('following')">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§</button>
    </p>
    <p>
      <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-default">
        âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†
      </a>
    </p>
    <div id="follow-list-popup" style="display:none; border:1px solid #ccc; padding:10px;"></div>
  {% else %}
    <!-- ä»–äººã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ -->
    <button id="follow-btn" data-user-id="{{ profile_user.id }}">
      ãƒ•ã‚©ãƒ­ãƒ¼
    </button>
  {% endif %}

  <hr>

  <h3>ğŸ“ {{ profile_user.username }} ã®æŠ•ç¨¿</h3>

  {% for tweet in tweets %}
    {% include 'core/tweet_card.html' with tweet=tweet show_controls=is_owner %}
  {% endfor %}

  {% if request.user == profile_user %}
    <script>
      function loadFollowList(type) {
        const userId = "{{ profile_user.id }}";
        fetch(`/${type}/${userId}/`)
          .then(response => response.json())
          .then(data => {
            const div = document.getElementById('follow-list-popup');
            div.innerHTML = '<h3>' + (type === 'followers' ? 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼' : 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­') + '</h3>';
            data.forEach(user => {
              div.innerHTML += '<p>' + user.username + '</p>';
            });
            div.style.display = 'block';
          });
      }
    </script>
  {% endif %}

  {% if request.user != profile_user %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('follow-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            fetch(`/follow-toggle/${userId}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Accept': 'application/json',
              }
            })
            .then(response => response.json())
            .then(data => {
              btn.textContent = data.status === 'followed' ? 'ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤' : 'ãƒ•ã‚©ãƒ­ãƒ¼';
            });
          });
        }
      });
    </script>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          fetch(`/like/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          })
          .then(res => res.json())
          .then(data => {
            btn.innerHTML = `â¤ï¸ ${data.count}ä»¶`;
          });
        });
      });

      document.querySelectorAll('.retweet-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          fetch(`/retweet_toggle/${id}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          })
          .then(res => res.json())
          .then(data => {
            btn.innerHTML = `ğŸ” ${data.count}ä»¶`;
          });
        });
      });

      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          window.location.href = `/reply/${id}/`;
        });
      });
    });
  </script>

{% endblock %}
